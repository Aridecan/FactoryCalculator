name: Release MSIX

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build-msix:
    name: Build WinUI and produce MSIX
    runs-on: windows-latest
    permissions:
      contents: read
      packages: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Restore
        run: dotnet restore FactoryCalculator.sln

      - name: Build (Release)
        run: dotnet build FactoryCalculator.sln --configuration Release --no-restore

      # Publish using the publish profile that creates the MSIX (PublishProfile files live under Properties\PublishProfiles)
      - name: Publish WinUI project (MSIX)
        run: |
          dotnet msbuild FactoryCalculator/FactoryCalculator.csproj -t:Restore;Publish -p:Configuration=Release -p:PublishProfile=win-x64.pubxml
        shell: pwsh

      - name: Verify MSIX artifacts exist
        id: find_msix
        shell: pwsh
        run: |
          $matches = Get-ChildItem -Path FactoryCalculator -Recurse -ErrorAction SilentlyContinue -Filter *.msix
          if (-not $matches) {
            Write-Error 'No .msix files were produced. Check PublishProfile and build logs.'
            exit 1
          }
          # Build semicolon-separated list for upload action input
          $paths = $matches | ForEach-Object { $_.FullName } | ForEach-Object { $_.Replace('\','/') } -join ';'
          echo "MSIX_PATHS=$paths" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Host "Found MSIX files:"
          $matches | ForEach-Object { Write-Host $_.FullName }

      # Create or update a GitHub Release for the pushed tag and upload the MSIX files as assets.
      # softprops/action-gh-release accepts glob patterns; we pass a pattern that matches the publish directory.
      - name: Create Release and upload MSIX assets
        uses: softprops/action-gh-release@v1
        with:
          # glob pattern expected; adjust if your publish directory differs
          files: FactoryCalculator/**/bin/**/publish/*.msix
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload build log artifact (for debugging)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            FactoryCalculator/**/bin/**/publish/**
            FactoryCalculator/**/bin/**/*